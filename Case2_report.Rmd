---
title: "Project Title"
author: "Olivia Fu, Christina Lee, Eunice Lee"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    toc: false
  bookdown::html_document2:
    toc: true
    number_sections: true
    fig_caption: true
editor: visual
---

# Background and Motivation

Researchers conducted a study to determine whether altering the genetic phenotype of mice influences mitochondrial function by measuring the metabolic efficiency under experimental conditions that varied in substrate type and energy demand. The aim was to compare activity levels between the control group (non-transgenic mice) and the treatment group (transgenic mice) using a multiplexed assay platform. To achieve this, the goal was to focus on building a modeling framework for the data, implementing a method for hypothesis testing to assess the genotype effect, and creating a graphical summary that could effectively highlight any patterns or trends shown in the data. The analysis focused on oxygen consumption rate (JO2) across different substrates and doses in order to better understand how genetic differences may influence mitochondrial efficiency.

# Data and Exploratory Analysis

The data for this analysis come from skeletal muscle mitochondria isolated from mice. Our primary outcome variable is JO2, the flux of oxygen, which reflects how much “work” mitochondria are capable of performing under given fuel and energy-demand conditions. We use JO2 as an indicator of metabolic efficiency. The main explanatory variable of interest is genotype, comparing mitochondria from transgenic (Tg) mice to those from non-transgenic (NT) controls, to evaluate whether genetic modification alters metabolic and functional phenotypes in mice. Additional design factors include substrate type and ΔGATP (dose), the latter reflecting the energetic workload imposed by the creatine kinase energy clamp.

We began with an exploratory analysis by plotting JO2 against ΔGATP, faceted by substrate type (Figure 1). Within each panel, data were further separated by genotype (Tg in teal, NT in red). We found that Tg mitochondria generally exhibited higher JO2 than NT mitochondria, suggesting greater respiratory capacity. Higher energetic demand (less negative ΔGATP) was associated with increased JO2, though the magnitude of this effect varied by substrate. In addition, each subject’s measurements appeared to start from a different baseline, implying that random intercepts for subjects may be appropriate in the modeling framework.

To better visualize overall trends, we next plotted group means with standard errors by substrate, genotype, and dose (Figure 2). Excluding the −12.95 ΔGATP condition, as recommended in the study protocol, JO2 increased approximately linearly with dose. Importantly, the effect of genotype varied by substrate. For OcM and PcM, the difference between Tg and NT remained relatively constant across doses, whereas for GM, PM, PMOc, and PMPc, the genotype effect widened at higher doses. These exploratory insights suggest that our model of JO2 should include interaction terms among genotype, substrate, and dose, while also accounting for individual-level variability.\

# Model Rationale, Implementation, and Evaluations

We chose to use a linear mixed-effects model to analyze JO2, because the data structure and biological context both support this framework. The outcome of interest, flux of oxygen, is measured repeatedly across multiple substrate and workload conditions for each mouse. This results in correlated observations within the same subject, which violates the independence assumption of ordinary linear regression. A mixed model accounts for this correlation by including a subject-specific random effect, allowing us to control for baseline differences across individuals.

Motivated by the study design and by patterns observed in our exploratory analysis, We selected genotype, substrate, and dose as fixed effects for the model. Genotype is the primary explanatory variable of interest, while substrate type and ΔGATP level are essential design factors that capture differences in metabolic pathway and energetic demand. The exploratory plot (Figure 2) revealed main effects of genotype and dose, as well as evidence that the genotype effect varies across substrates and becomes more pronounced at higher doses. These observations provide strong justification for including interaction terms among genotype, substrate, and dose.\

To determine the random effects structure, we compared a model with subject-level random effects to one with pair-level random effects. While each mouse subject may have a distinct baseline, paired subjects could share correlation because their measurements were conducted together. As shown in Table 1, the subject-level random effect model provided a better fit, with lower AIC and BIC values. We also evaluated the inclusion of interaction terms by comparing a model with only two-way interactions to a full model with all three-way interactions. According to Table 2, the full three-way interaction model again yielded lower AIC and BIC values.

## Rationale & Selection

Before model fitting, we cleaned the dataset by excluding the Basal condition and the −12.95 dose level, as these are not typically included in the analysis, and by removing observations with missing values. Doses were treated as a continuous numeric variable.

The model was fit in R using the lmer() function from the lme4 package, with full three-way interaction terms for genotype, substrate, and dose (group\*substrate\*dose) and a random intercept for subject (1 \| Subject). This specification accounts for within-subject correlation and baseline variability.

## Implementation

$$
JO2_{ij} = \beta_0 + \beta_1 Group_i + \beta_2 Dose_i + \beta_3^{\top} Substrate_i \\
\quad + \beta_4 (Group_i*Dose_i) + \beta_5^{\top} (Group_i*Substrate_i) + \beta_6^{\top} (Dose_i*Substrate_i) \\
\quad + \beta_7^{\top} (Group_i*Dose_i*Substrate_i) + u_j + \varepsilon_{ij}
$$

$$
u_j \sim N(0, \sigma^2_{\text{Subject}}) \\
\varepsilon_{ij} \sim N(0, \sigma^2)
$$

## Evaluation

To evaluate whether the model provided a good fit for the data, we examined multiple residual plots. The Q–Q plots for both Residuals and Random Effects (Figure 4) showed that most points lay close to the diagonal line, with only a few outliers present at the tails. This supports the normality assumption for our model. Furthermore, The Residuals vs. Fitted Values plot (Figure 5) showed that the points were randomly scattered around the zero line, which supports the constant variance assumption since there were no clear clustering or patterns present. To add on, the Residuals plotted by Group and Substrate (Figure 6) also showed no strong deviations, which suggested independence across these factors for our data. However, the residuals plotted by Dose (Figure 6) displayed a slight curvature, which may indicate potential nonlinearity in that variable. Additionally, the marginal (fixed effects) R2 was 0.90, and the conditional (fixed + random effects) R2 was 0.97 (Figure 7). This means Genotype, Substrate, Dose, and their interactions explained about 90% of the variation in JO₂. When the random effects were also included, this explained 97% of the variation. These high R2 values support that the model is a good fit to the data. Overall, these diagnostics suggest that our model fits the data well and generally satisfies the regression assumptions.

# Results

# Limitations and Conclusion

Based on our analysis, due to the potential nonlinearity shown in the residual graph for Dose (Figure 6), we believe applying a log transformation or adding higher order terms in future work may help improve the model results. Since the Group and Substrate variables did not show any limitations to supporting the independence assumption, trying to evaluate and improve the Dose variable is a priority. Additionally, to address the few outliers present in the Residuals and Random Effects QQ Plot (Figure 4), taking a closer look at the data to evaluate these areas is important in order to find potential data entry errors or a cause to the skewed points. A transformation to the model and looking at other diagnostics including Cook’s distance or leverage are a part of the next steps to account for the normality assumption. To add on, because there could be potential confounding effects from dPsi, Redox, e-1 leak, auranofin, and cdnb, it would be beneficial to check for any correlations between these variables and JO2, Dose, and Substrate on a deeper level. Maybe getting access to the dataset with these points instead of looking solely based on the plots provided would help support a more thorough evaluation.

\pagebreak

# Appendix

```{r include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(readr)
library(lme4)
library(kableExtra)
library(patchwork)

knitr::opts_chunk$set(echo = FALSE)
```

```{r load-data}
data <- read_csv("JO2.csv", col_names = FALSE, show_col_types = FALSE)
```

```{r clean-data}
# extract substrate and dose
substrate  <- as.character(data[1, ])
dose  <- as.character(data[2, ])

# fill in substrate for each column
substrate <- trimws(sub("\\s*\\(.*\\)$", "", substrate))
substrate <- na_if(substrate, "")
substrate <- na_if(substrate, "NA")
substrate <- fill(tibble(Substrate = substrate),
                         Substrate, .direction = "down")$Substrate

# build new column names
new_names <- ifelse(tolower(dose) == "subject", "Subject",
                    paste0(substrate, ".", dose))
data <- data[-c(1,2), ]
names(data) <- make.unique(new_names, sep = "_")

# solve type issue
val_cols <- setdiff(names(data), "Subject")
data[val_cols] <- lapply(data[val_cols], function(x) {
  if (is.character(x)) parse_number(x) else as.numeric(x)
})

# make the longer table
data_cleaned <- data |>
  pivot_longer(
    cols = -Subject,
    names_to     = c("substrate", "dose"),
    names_pattern = "^([^.]+)\\.(.+)$",       # split once at first dot
    values_to    = "Value"
) |>
  mutate(
    group = ifelse(grepl("^NT", Subject, ignore.case=TRUE), "NT", "Tg")
  )
```

```{r}
data_plot <- data_cleaned |>
  # don't include basal in the plot
  filter(dose != "Basal") |>
  # treat dose as continuous numeric values
  mutate(dose = as.numeric(dose))
```

Figure 1: Scatterplots of JO2 versus ΔGATP, faceted by substrate type and separated by genotype (Tg in teal, NT in red). Each point represents an individual observation. The plots illustrate generally higher JO2 in Tg mitochondria, increasing trends with dose, and variability in baseline metabolic activity across subjects.

```{r fig-1, fig.cap="Scatterplots of $J O_{2}$ versus $\\Delta G_{ATP}$, faceted by substrate type and separated by genotype (Tg in teal, NT in red). Each point represents an individual observation. The plots illustrate generally higher $J O_{2}$ in Tg mitochondria, increasing trends with dose, and variability in baseline metabolic activity across subjects.", warning=FALSE}

ggplot(data_plot, aes(dose, Value,
                      group = interaction(Subject, substrate),
                      color = group)) +
  geom_line(alpha = 0.35) +
  geom_point(alpha = 0.7, size = 1.8) +
  facet_wrap(~ substrate) +
  labs(x = expression(Delta*G[ATP]), y = "JO2") +
  scale_x_continuous(
    breaks = c(-14.49, -14.36, -14.19, -13.95, -13.65, -12.95)
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Figure 2: Mean JO2 with standard errors plotted against ΔGATP, grouped by substrate and genotype. Excluding the −12.95 ΔGATP condition, the relationship between JO2 and workload appears approximately linear. Genotype effects are consistent for OcM and PcM, while they become more pronounced at higher workloads for GM, PM, PMOc, and PMPc.

```{r fig-2, fig.cap="Mean $J O_{2}$ with standard errors plotted against $\\Delta G_{ATP}$, grouped by substrate and genotype. Excluding the $-12.95\\, \\Delta G_{ATP}$ condition, the relationship between $J O_{2}$ and workload appears approximately linear. Genotype effects are consistent for OcM and PcM, while they become more pronounced at higher workloads for GM, PM, PMOc, and PMPc.", warning=FALSE}

# calculate mean and se for each group
sum_df <- data_plot |>
  group_by(substrate, group, dose) |>
  summarise(mean = mean(Value, na.rm = TRUE),
            se   = sd(Value, na.rm = TRUE) / sqrt(sum(!is.na(Value))),
            .groups = "drop")

ggplot(sum_df, aes(dose, mean, color = group, group = group)) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = mean - se, 
                    ymax = mean + se), 
                width = 0.12) +
  facet_wrap(~ substrate) +
  labs(x = expression(Delta*G[ATP]),
       y = "JO2 (mean +- SE)") +
  scale_x_continuous(
    breaks = c(-14.49, -14.36, -14.19, -13.95, -13.65, -12.95)
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
data_model <- data_cleaned |>
  # exclude Basal and -12.95 for modeling
  filter(dose != "Basal", dose != "-12.95") |>
  # treat dose as numeric, others as factor
  mutate(substrate = factor(substrate),
         dose = as.numeric(dose),
         Subject = factor(Subject),
         Pair = factor(parse_number(as.character(Subject)))) |>
  drop_na()
```

```{r}
# our final model
lmm_full_subject <- lmer(
  Value ~ group * substrate * dose +
        (1 | Subject),
  data = data_model, REML = TRUE
)
```

Table 1:

```{r message=FALSE}
# compare with pair random effect
lmm_full_pair <- lmer(
  Value ~ group * substrate * dose +
          (1 | Pair), 
  data = data_model, REML = TRUE
)

comp_random <- anova(lmm_full_pair, lmm_full_subject)

kable(comp_random, 
      digits = 3, 
      caption = "Model comparison between pair and subject random effects") |>
  kable_styling(latex_options = "HOLD_position")
```

Table 2:

```{r message=FALSE}
# compare with 2-way interaction terms
lmm_2ways_subject <- lmer(
  Value ~ group * substrate + group * dose + substrate * dose +
          (1 | Subject),
  data = data_model, REML = TRUE
)

comp_fix <- anova(lmm_2ways_subject, lmm_full_subject)

kable(comp_fix, 
      digits = 3, 
      caption = "Model comparison between two-way interaction terms and full three-way interactions") |>
  kable_styling(latex_options = "HOLD_position")
```

Figure 3 for results: CAPTION NEEDED

```{r}
# sequence of doses for smooth fitted curves
dose_seq <- seq(min(data_model$dose),
                max(data_model$dose),
                length.out = 100)

# build grid for predictions
newdat <- expand_grid(
  dose      = dose_seq,
  substrate = unique(data_model$substrate),
  group     = unique(data_model$group)
)

# predict fitted values (fixed effects only)
newdat$pred <- predict(lmm_full_subject,
                       newdata = newdat,
                       re.form = NA)

# plot: raw data as points, fitted as smooth lines
ggplot() +
  geom_point(data = data_model,
             aes(x = dose, y = Value, color = group),
             alpha = 0.5, size = 2) +
  geom_line(data = newdat,
            aes(x = dose, y = pred, color = group),
            size = 1.2) +
  facet_wrap(~ substrate, scales = "free_y") +
  labs(x = expression(Delta*G[ATP]),
       y = "JO2",
       title = "JO2 vs dose by genotype and substrate") +
  theme_bw() +
  theme(legend.position = "top") +
  scale_x_continuous(
    breaks = c(-14.49, -14.36, -14.19, -13.95, -13.65, -12.95)
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Figure 4: Shows Q-Q plots of residuals and random effects based on the model. Most data points follow the red diagonal line, supporting normality. There are a few outliers present near the tail ends.

```{r}
# Plot residuals and random effects side by side
par(mfrow = c(1, 2), las = 1)

# Residuals Q-Q plot
qqnorm(residuals(lmm_full_subject), main = "Residuals")
qqline(residuals(lmm_full_subject), col = "red")

# Random effects Q-Q plot (Subjects)
qqnorm(unlist(ranef(lmm_full_subject)$Subject), main = "Random Effects")
qqline(unlist(ranef(lmm_full_subject)$Subject), col = "red")
```

Figure 5: Shows the Residual vs. Fitted Values. Points are randomly spread out about the zero line, which supports the constant variance assumption. 

```{r}
# Extract residuals and fitted values
resid_vals <- resid(lmm_full_subject)
fitted_vals <- fitted(lmm_full_subject)

# Residuals vs Fitted plot
p1 <- ggplot(data.frame(Fitted = fitted_vals, Residuals = resid_vals), 
             aes(x = Fitted, y = Residuals)) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  theme_minimal() +
  labs(title = "Residuals vs Fitted", x = "Fitted values", y = "Residuals")

p1
```

Figure 6: Shows box plots for Group and Substrate variables, and scatterplot for Dose variable. Slight curvature shown in Residuals by Dose, which affects independence assumption.

```{r}
# Extract residuals
resid_vals <- resid(lmm_full_subject)

# Add residuals to dataset
data_resid <- data_model
data_resid$Residuals <- resid_vals

# Residuals vs group (categorical)
p1 <- ggplot(data_resid, aes(x = group, y = Residuals)) +
  geom_boxplot(outlier.colour = "red", alpha = 0.6) +
  theme_minimal() +
  labs(title = "Residuals by Group")

# Residuals vs substrate (categorical)
p2 <- ggplot(data_resid, aes(x = substrate, y = Residuals)) +
  geom_boxplot(outlier.colour = "red", alpha = 0.6) +
  theme_minimal() +
  labs(title = "Residuals by Substrate")

# Residuals vs dose (continuous or factor?)
# If continuous:
p3 <- ggplot(data_resid, aes(x = dose, y = Residuals)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess", se = FALSE, color = "blue") +
  theme_minimal() +
  labs(title = "Residuals by Dose")

p1 + p2 + p3
```

Figure 7:

```{r}
# r squared calculation
library(MuMIn)
r2_values <- r.squaredGLMM(lmm_full_subject)
r2_values

# R2m = marginal R² (fixed effects)
# R2c = conditional R² (fixed + random effects)
```
